pipeline {
    agent any

    enviroment {
        FPT_ACR_CREDENTIALS = credentials('FPT-AMS-ACR-CREDENTALS')
        FPT_ACR_URL = "fptamsdevacr.azurecr.io"
        FPT_ACR_NAME = "fptamsdevacr"
        COMMIT_HASH = sh(script: 'git rev-parse HEAD', returnStdout: true).trim()
        SERVICE_NAME = "java"

    }

    stages {
        stage("login ACR") {
            steps {
                sh "docker login $FPT_ACR_URL -u $FPT_ACR_CREDENTIALS -p $FPT_ACR_CREDENTIALS "
            }
        }
        stage("build image") {
            steps {
                sh "docker build -t $FPT_ACR_URL/$SERVICE_NAME:${COMMIT_HASH}_{$BUILD_NUMBER} -f Dockerfile ." 
            }
        }

        stage("push Image") {
            steps {
                sh "docker push $FPT_ACR_URL/$SERVICE_NAME:${COMMIT_HASH}_{$BUILD_NUMBER}"
                //sh "docker stop getting"
                
            }
        }
         stage("check images pushed") {
            steps {
                //show tag of repository name in ACR
                sh"az acr repository show-tags --name $FPT_ACR_NAME --repository $SERVICE_NAME --output table"
                //sh"az acr repository list --name $FPT_ACR_NAME --output table"
                //sh "docker stop getting"
                
            }
        }
}
      
            post {
                always {
                   sh 'docker rmi $FPT_ACR_URL/$SERVICE_NAME:${COMMIT_HASH}_{$BUILD_NUMBER} '
                   sh 'docker images'
                 
                }
            }
        
}
